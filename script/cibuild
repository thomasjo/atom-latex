#!/usr/bin/env bash

# Exit on failure, and treat expansion of unset variables as an error.
set -eu

# Enable case-insensitive pattern matching.
shopt -s nocasematch

initialize() {
  local script_dir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P )"
  local scripts=(install-texlive install-miktex install-knitr)

  for script in ${scripts[@]}; do
    source "${script_dir}/${script}"
  done
}

install_latex_distribution() {
  if [[ "${TEX_DIST:=texlive}" == "miktex" ]]; then
    install_miktex
  else
    install_texlive
  fi
}

exec_ci() {
  if [[ "${APPVEYOR:-}" == true ]]; then
    Rscript -e "library(knitr)" -e "knit('spec\\\\fixtures\\\\knitr\\\\file.Rnw')"
    local script_path="/tmp/build-package.ps1"
    curl -so ${script_path} "https://raw.githubusercontent.com/atom/ci/master/build-package.ps1"
    powershell -noninteractive -noprofile -command "${script_path}"
    if [[ "${TEX_DIST:=texlive}" == "miktex" ]]; then
      mpm --admin --list
    fi
  else
    curl -s "https://raw.githubusercontent.com/atom/ci/master/build-package.sh" | sh
  fi
}

main() {
  initialize
  install_latex_distribution
  install_knitr
  exec_ci
}

main "$@"
